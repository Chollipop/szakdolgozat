using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using OxyPlot;
using OxyPlot.Axes;
using OxyPlot.Series;
using System.Collections.Concurrent;
using System.Collections.ObjectModel;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using szakdolgozat.Models;
using szakdolgozat.Services;
using szakdolgozat.Views;

namespace szakdolgozat.ViewModels
{
    public class AssetVulnerabilityViewModel : BaseViewModel
    {
        private AssetVulnerability _selectedAssetVulnerability;

        private ChartExportService _chartExportService;

        public ObservableCollection<AssetVulnerability> AssetVulnerabilities { get; set; }

        public AssetVulnerability SelectedAssetVulnerability
        {
            get => _selectedAssetVulnerability;
            set
            {
                _selectedAssetVulnerability = value;
                OnPropertyChanged(nameof(SelectedAssetVulnerability));
            }
        }

        public ICommand AddVulnerabilityCommand { get; set; }
        public ICommand UpdateVulnerabilityCommand { get; set; }
        public ICommand DeleteVulnerabilityCommand { get; set; }
        public ICommand GenerateChartCommand { get; }

        public AssetVulnerabilityViewModel()
        {
            LoadAssetVulnerabilities();

            _chartExportService = App.ServiceProvider.GetRequiredService<ChartExportService>();

            AddVulnerabilityCommand = new RelayCommand(AddVulnerability);
            UpdateVulnerabilityCommand = new RelayCommand(UpdateVulnerability, CanUpdateAssetVulnerability);
            DeleteVulnerabilityCommand = new RelayCommand(DeleteVulnerability, CanDeleteAssetVulnerability);
            GenerateChartCommand = new RelayCommand(ShowChartSelectionDialog);
        }

        private async Task LoadAssetVulnerabilities()
        {
            using (var scope = App.ServiceProvider.CreateScope())
            {
                var context = scope.ServiceProvider.GetRequiredService<AssetDbContext>();
                var assetVulnerabilitiesList = await context.AssetVulnerabilities
                    .Include(av => av.Asset)
                    .Include(av => av.Vulnerability)
                    .Select(av => new AssetVulnerability
                    {
                        AssetID = av.AssetID,
                        VulnerabilityID = av.VulnerabilityID,
                        Probability = av.Probability,
                        Impact = av.Impact,
                        Action = av.Action,
                        Asset = av.Asset,
                        Vulnerability = av.Vulnerability
                    })
                    .ToListAsync();
                AssetVulnerabilities = new ObservableCollection<AssetVulnerability>(assetVulnerabilitiesList);
                OnPropertyChanged(nameof(AssetVulnerabilities));
            }
        }

        private bool CanAssignAssets()
        {
            using (var scope = App.ServiceProvider.CreateScope())
            {
                var context = scope.ServiceProvider.GetRequiredService<AssetDbContext>();
                var assetsCount = context.Assets.Where(a => a.Status == "Active").Count();
                if (assetsCount == 0) return false;
            }
            return true;
        }

        private async void AddVulnerability()
        {
            if (!CanAssignAssets())
            {
                MessageBox.Show("There are no assets available for assignment.", "No assets available", MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }
            var viewModel = new AssetVulnerabilityDialogViewModel();
            var addAssetVulnerabilityWindow = new AssetVulnerabilityDialogView(viewModel);
            addAssetVulnerabilityWindow.Title = "Add Vulnerability";
            if (addAssetVulnerabilityWindow.ShowDialog() == true)
            {
                var newAssetVulnerability = viewModel.AssetVulnerability;
                using (var scope = App.ServiceProvider.CreateScope())
                {
                    var context = scope.ServiceProvider.GetRequiredService<AssetDbContext>();
                    if (newAssetVulnerability.Asset != null)
                    {
                        context.Assets.Attach(newAssetVulnerability.Asset);
                    }

                    if (newAssetVulnerability.Vulnerability != null)
                    {
                        context.Vulnerabilities.Attach(newAssetVulnerability.Vulnerability);
                    }

                    context.AssetVulnerabilities.Add(newAssetVulnerability);

                    await context.SaveChangesAsync();
                }
                AssetVulnerabilities.Add(newAssetVulnerability);
                OnPropertyChanged(nameof(AssetVulnerabilities));
            }
        }

        private bool CanUpdateAssetVulnerability()
        {
            return SelectedAssetVulnerability != null;
        }

        private async void UpdateVulnerability()
        {
            if (SelectedAssetVulnerability != null)
            {
                var viewModel = new AssetVulnerabilityDialogViewModel(SelectedAssetVulnerability);
                var addAssetVulnerabilityWindow = new AssetVulnerabilityDialogView(viewModel);
                addAssetVulnerabilityWindow.Title = "Update Vulnerability";
                if (addAssetVulnerabilityWindow.ShowDialog() == true)
                {
                    var updatedAssetVulnerability = viewModel.AssetVulnerability;

                    using (var scope = App.ServiceProvider.CreateScope())
                    {
                        var context = scope.ServiceProvider.GetRequiredService<AssetDbContext>();

                        SelectedAssetVulnerability.Probability = updatedAssetVulnerability.Probability;
                        SelectedAssetVulnerability.Impact = updatedAssetVulnerability.Impact;
                        SelectedAssetVulnerability.Action = updatedAssetVulnerability.Action;

                        context.AssetVulnerabilities.Update(SelectedAssetVulnerability);

                        await context.SaveChangesAsync();
                    }

                    int index = AssetVulnerabilities.IndexOf(SelectedAssetVulnerability);
                    AssetVulnerabilities.RemoveAt(index);
                    AssetVulnerabilities.Insert(index, updatedAssetVulnerability);
                    OnPropertyChanged(nameof(AssetVulnerabilities));
                }
            }
        }

        private bool CanDeleteAssetVulnerability()
        {
            return SelectedAssetVulnerability != null;
        }

        private async void DeleteVulnerability()
        {
            if (SelectedAssetVulnerability != null)
            {
                var result = MessageBox.Show($"Are you sure you want to delete the vulnerability '{SelectedAssetVulnerability.Asset.AssetName} - {SelectedAssetVulnerability.Vulnerability.Name}'?", "Confirm Deletion", MessageBoxButton.YesNo, MessageBoxImage.Warning);
                if (result == MessageBoxResult.Yes)
                {
                    using (var scope = App.ServiceProvider.CreateScope())
                    {
                        var context = scope.ServiceProvider.GetRequiredService<AssetDbContext>();

                        context.AssetVulnerabilities.Remove(SelectedAssetVulnerability);

                        await context.SaveChangesAsync();
                    }

                    var deletedAsset = SelectedAssetVulnerability;
                    int index = AssetVulnerabilities.IndexOf(SelectedAssetVulnerability);
                    AssetVulnerabilities.RemoveAt(index);
                    OnPropertyChanged(nameof(AssetVulnerabilities));
                }
            }
        }

        private void ShowChartSelectionDialog()
        {
            var dialog = new Window
            {
                Title = "Select Chart Type",
                Width = 450,
                Height = 175,
                ResizeMode = ResizeMode.NoResize,
                WindowStartupLocation = WindowStartupLocation.CenterScreen
            };

            var grid = new Grid
            {
                Margin = new Thickness(10)
            };

            grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });
            grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });

            grid.ColumnDefinitions.Add(new ColumnDefinition());
            grid.ColumnDefinitions.Add(new ColumnDefinition());

            var stackPanel1 = new StackPanel();
            var stackPanel2 = new StackPanel();

            var assetCountPerVulnerability = new RadioButton
            {
                Content = "Asset Count Per Vulnerability",
                Margin = new Thickness(0, 0, 0, 10),
                IsChecked = true,
                Tag = "Vulnerability",
                GroupName = "group"
            };

            var assetCountPerProbability = new RadioButton
            {
                Content = "Asset Count Per Probability",
                Margin = new Thickness(0, 0, 0, 10),
                Tag = "Probability",
                GroupName = "group"
            };

            var assetCountPerImpact = new RadioButton
            {
                Content = "Asset Count Per Impact",
                Margin = new Thickness(0, 0, 0, 10),
                Tag = "Impact",
                GroupName = "group"
            };

            var assetDistributionByVulnerability = new RadioButton
            {
                Content = "Asset Distribution By Vulnerability",
                Margin = new Thickness(0, 0, 0, 10),
                Tag = "Vulnerability",
                GroupName = "group"
            };

            var assetDistributionByProbability = new RadioButton
            {
                Content = "Asset Distribution By Probability",
                Margin = new Thickness(0, 0, 0, 10),
                Tag = "Probability",
                GroupName = "group"
            };

            var assetDistributionByImpact = new RadioButton
            {
                Content = "Asset Distribution By Impact",
                Margin = new Thickness(0, 0, 0, 10),
                Tag = "Impact",
                GroupName = "group"
            };

            stackPanel1.Children.Add(assetCountPerVulnerability);
            stackPanel1.Children.Add(assetCountPerProbability);
            stackPanel1.Children.Add(assetCountPerImpact);

            stackPanel2.Children.Add(assetDistributionByVulnerability);
            stackPanel2.Children.Add(assetDistributionByProbability);
            stackPanel2.Children.Add(assetDistributionByImpact);

            Grid.SetRow(stackPanel1, 0);
            Grid.SetColumn(stackPanel1, 0);

            Grid.SetRow(stackPanel2, 0);
            Grid.SetColumn(stackPanel2, 1);

            grid.Children.Add(stackPanel1);
            grid.Children.Add(stackPanel2);

            var okButton = new Button
            {
                Content = "Generate",
                Width = 75,
                Height = 30,
                Margin = new Thickness(0, 10, 0, 0),
                HorizontalAlignment = System.Windows.HorizontalAlignment.Right
            };

            var cancelButton = new Button
            {
                Content = "Cancel",
                Width = 75,
                Height = 30,
                Margin = new Thickness(10, 10, 0, 0),
                HorizontalAlignment = System.Windows.HorizontalAlignment.Left
            };

            var buttonPanel = new StackPanel
            {
                Orientation = Orientation.Horizontal,
                HorizontalAlignment = System.Windows.HorizontalAlignment.Center
            };

            buttonPanel.Children.Add(okButton);
            buttonPanel.Children.Add(cancelButton);

            Grid.SetRow(buttonPanel, 1);
            Grid.SetColumnSpan(buttonPanel, 2);

            grid.Children.Add(buttonPanel);

            dialog.Content = grid;

            okButton.Click += (sender, e) =>
            {
                if (assetCountPerVulnerability.IsChecked == true)
                {
                    GenerateColumnChart(assetCountPerVulnerability.Tag.ToString());
                }
                else if (assetCountPerProbability.IsChecked == true)
                {
                    GenerateColumnChart(assetCountPerProbability.Tag.ToString());
                }
                else if (assetCountPerImpact.IsChecked == true)
                {
                    GenerateColumnChart(assetCountPerImpact.Tag.ToString());
                }
                else if (assetDistributionByVulnerability.IsChecked == true)
                {
                    GeneratePiechart(assetDistributionByVulnerability.Tag.ToString());
                }
                else if (assetDistributionByProbability.IsChecked == true)
                {
                    GeneratePiechart(assetDistributionByProbability.Tag.ToString());
                }
                else if (assetDistributionByImpact.IsChecked == true)
                {
                    GeneratePiechart(assetDistributionByImpact.Tag.ToString());
                }
                dialog.DialogResult = true;
                dialog.Close();
            };

            cancelButton.Click += (sender, e) =>
            {
                dialog.DialogResult = false;
                dialog.Close();
            };

            dialog.ShowDialog();
        }

        private void GenerateColumnChart(string tag)
        {
            var barModel = new PlotModel { Title = $"Asset Count Per {tag}" };

            ConcurrentDictionary<string, int> data = new ConcurrentDictionary<string, int>();
            foreach (var assetVulnerability in AssetVulnerabilities)
            {
                string key = tag switch
                {
                    "Vulnerability" => assetVulnerability.Vulnerability.Name,
                    "Probability" => assetVulnerability.Probability.ToString(),
                    "Impact" => assetVulnerability.Impact.ToString(),
                };

                data.AddOrUpdate(key, 1, (k, oldValue) => oldValue + 1);
            }

            var sortedData = tag == "Impact" || tag == "Probability" ? data.OrderBy(kvp => int.Parse(kvp.Key)).ToList() : data.OrderByDescending(kvp => kvp.Value).ToList();

            var categoryAxis = new CategoryAxis
            {
                Position = AxisPosition.Bottom,
                Key = "CategoryAxis"
            };

            foreach (var kvp in sortedData)
            {
                categoryAxis.Labels.Add(kvp.Key);
            }

            var valueAxis = new LinearAxis
            {
                Position = AxisPosition.Left,
                Key = "ValueAxis",
                Minimum = 0,
                Title = "Values",
                MajorStep = 1
            };

            barModel.Axes.Add(categoryAxis);
            barModel.Axes.Add(valueAxis);

            var barSeries = new BarSeries
            {
                LabelPlacement = LabelPlacement.Inside,
                LabelFormatString = "{0}",
                XAxisKey = "ValueAxis",
                YAxisKey = "CategoryAxis"
            };

            foreach (var kvp in sortedData)
            {
                var barItem = new BarItem { Value = kvp.Value };
                if (tag == "Impact" || tag == "Probability")
                {
                    barItem.Color = GetColorForValue(int.Parse(kvp.Key));
                }
                barSeries.Items.Add(barItem);
            }

            barModel.Series.Add(barSeries);

            _chartExportService.ExportColumnChart(barModel);
        }

        private void GeneratePiechart(string tag)
        {
            var pieModel = new PlotModel { Title = $"Asset Distribution By {tag}" };

            ConcurrentDictionary<string, int> data = new ConcurrentDictionary<string, int>();
            foreach (var assetVulnerability in AssetVulnerabilities)
            {
                string key = tag switch
                {
                    "Vulnerability" => assetVulnerability.Vulnerability.Name,
                    "Probability" => assetVulnerability.Probability.ToString(),
                    "Impact" => assetVulnerability.Impact.ToString(),
                };

                data.AddOrUpdate(key, 1, (k, oldValue) => oldValue + 1);
            }

            int totalVulnerabilities = data.Values.Sum();

            var sortedData = tag == "Impact" || tag == "Probability" ? data.OrderBy(kvp => int.Parse(kvp.Key)).ToList() : data.OrderByDescending(kvp => kvp.Value).ToList();

            var pieSeries = new PieSeries
            {
                StrokeThickness = 2.0,
                InsideLabelPosition = 0.8,
                AngleSpan = 360,
                StartAngle = 0,
                InsideLabelFormat = "{1} ({0:F1}%)"
            };

            foreach (var kvp in sortedData)
            {
                double percentage = (double)kvp.Value / totalVulnerabilities * 100;
                var pieSlice = new PieSlice(kvp.Key, percentage);
                if (tag == "Impact" || tag == "Probability")
                {
                    pieSlice.Fill = GetColorForValue(int.Parse(kvp.Key));
                }
                pieSeries.Slices.Add(pieSlice);
            }

            pieModel.Series.Add(pieSeries);

            _chartExportService.ExportPiechart(pieModel);
        }

        private OxyColor GetColorForValue(int value)
        {
            switch (value)
            {
                case 1: return OxyColors.Green;
                case 2: return OxyColors.YellowGreen;
                case 3: return OxyColors.Yellow;
                case 4: return OxyColors.Orange;
                case 5: return OxyColors.Red;
                default: return OxyColors.Green;
            }
        }
    }
}
